{"ast":null,"code":"/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\n\n/* eslint-disable complexity, max-statements */\nvar http = require('./http');\n\nvar util = require('./util');\n\nvar Q = require('q');\n\nvar AuthSdkError = require('./errors/AuthSdkError');\n\nvar AuthPollStopError = require('./errors/AuthPollStopError');\n\nvar config = require('./config');\n\nfunction addStateToken(res, options) {\n  var builtArgs = {};\n  util.extend(builtArgs, options); // Add the stateToken if one isn't passed and we have one\n\n  if (!builtArgs.stateToken && res.stateToken) {\n    builtArgs.stateToken = res.stateToken;\n  }\n\n  return builtArgs;\n}\n\nfunction getStateToken(res) {\n  return addStateToken(res);\n}\n\nfunction transactionStatus(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/api/v1/authn', args);\n}\n\nfunction resumeTransaction(sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to resume'));\n    }\n  }\n\n  return sdk.tx.status(args).then(function (res) {\n    return new AuthTransaction(sdk, res);\n  });\n}\n\nfunction introspect(sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to evaluate'));\n    }\n  }\n\n  return transactionStep(sdk, args).then(function (res) {\n    return new AuthTransaction(sdk, res);\n  });\n}\n\nfunction transactionStep(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/idp/idx/introspect', args);\n}\n\nfunction transactionExists(sdk) {\n  // We have a cookie state token\n  return !!sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n}\n\nfunction postToTransaction(sdk, url, args, options) {\n  return http.post(sdk, url, args, options).then(function (res) {\n    return new AuthTransaction(sdk, res);\n  });\n}\n\nfunction getPollFn(sdk, res, ref) {\n  return function (options) {\n    var delay;\n    var rememberDevice;\n    var autoPush;\n    var transactionCallBack;\n\n    if (util.isNumber(options)) {\n      delay = options;\n    } else if (util.isObject(options)) {\n      delay = options.delay;\n      rememberDevice = options.rememberDevice;\n      autoPush = options.autoPush;\n      transactionCallBack = options.transactionCallBack;\n    }\n\n    if (!delay && delay !== 0) {\n      delay = config.DEFAULT_POLLING_DELAY;\n    } // Get the poll function\n\n\n    var pollLink = util.getLink(res, 'next', 'poll');\n\n    function pollFn() {\n      var opts = {};\n\n      if (typeof autoPush === 'function') {\n        try {\n          opts.autoPush = !!autoPush();\n        } catch (e) {\n          return Q.reject(new AuthSdkError('AutoPush resulted in an error.'));\n        }\n      } else if (autoPush !== undefined && autoPush !== null) {\n        opts.autoPush = !!autoPush;\n      }\n\n      if (typeof rememberDevice === 'function') {\n        try {\n          opts.rememberDevice = !!rememberDevice();\n        } catch (e) {\n          return Q.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n        }\n      } else if (rememberDevice !== undefined && rememberDevice !== null) {\n        opts.rememberDevice = !!rememberDevice;\n      }\n\n      var href = pollLink.href + util.toQueryParams(opts);\n      return http.post(sdk, href, getStateToken(res), {\n        saveAuthnState: false\n      });\n    }\n\n    ref.isPolling = true;\n    var retryCount = 0;\n\n    var recursivePoll = function () {\n      // If the poll was manually stopped during the delay\n      if (!ref.isPolling) {\n        return Q.reject(new AuthPollStopError());\n      }\n\n      return pollFn().then(function (pollRes) {\n        // Reset our retry counter on success\n        retryCount = 0; // If we're still waiting\n\n        if (pollRes.factorResult && pollRes.factorResult === 'WAITING') {\n          // If the poll was manually stopped while the pollFn was called\n          if (!ref.isPolling) {\n            throw new AuthPollStopError();\n          }\n\n          if (typeof transactionCallBack === 'function') {\n            transactionCallBack(pollRes);\n          } // Continue poll\n\n\n          return Q.delay(delay).then(recursivePoll);\n        } else {\n          // Any non-waiting result, even if polling was stopped\n          // during a request, will return\n          ref.isPolling = false;\n          return new AuthTransaction(sdk, pollRes);\n        }\n      }).fail(function (err) {\n        // Exponential backoff, up to 16 seconds\n        if (err.xhr && (err.xhr.status === 0 || err.xhr.status === 429) && retryCount <= 4) {\n          var delayLength = Math.pow(2, retryCount) * 1000;\n          retryCount++;\n          return Q.delay(delayLength).then(recursivePoll);\n        }\n\n        throw err;\n      });\n    };\n\n    return recursivePoll().fail(function (err) {\n      ref.isPolling = false;\n      throw err;\n    });\n  };\n}\n\nfunction link2fn(sdk, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function (name, opts) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = util.find(link, {\n        name: name\n      });\n\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, res, obj, lk, ref)(opts);\n    };\n  } else if (link.hints && link.hints.allow && link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n\n    switch (method) {\n      case 'GET':\n        return function () {\n          return http.get(sdk, link.href);\n        };\n\n      case 'POST':\n        return function (opts) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL' || res.status === 'FACTOR_ENROLL') {\n            // Add factorType and provider\n            util.extend(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var params = {};\n          var autoPush = data.autoPush;\n\n          if (autoPush !== undefined) {\n            if (typeof autoPush === 'function') {\n              try {\n                params.autoPush = !!autoPush();\n              } catch (e) {\n                return Q.reject(new AuthSdkError('AutoPush resulted in an error.'));\n              }\n            } else if (autoPush !== null) {\n              params.autoPush = !!autoPush;\n            }\n\n            data = util.omit(data, 'autoPush');\n          }\n\n          var rememberDevice = data.rememberDevice;\n\n          if (rememberDevice !== undefined) {\n            if (typeof rememberDevice === 'function') {\n              try {\n                params.rememberDevice = !!rememberDevice();\n              } catch (e) {\n                return Q.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n              }\n            } else if (rememberDevice !== null) {\n              params.rememberDevice = !!rememberDevice;\n            }\n\n            data = util.omit(data, 'rememberDevice');\n          } else if (data.profile && data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              params.updatePhone = true;\n            }\n\n            data.profile = util.omit(data.profile, 'updatePhone');\n          }\n\n          var href = link.href + util.toQueryParams(params);\n          return postToTransaction(sdk, href, data);\n        };\n    }\n  }\n}\n\nfunction links2fns(sdk, res, obj, ref) {\n  var fns = {};\n\n  for (var linkName in obj._links) {\n    if (!obj._links.hasOwnProperty(linkName)) {\n      continue;\n    }\n\n    var link = obj._links[linkName];\n\n    if (linkName === 'next') {\n      linkName = link.name;\n    }\n\n    if (link.type) {\n      fns[linkName] = link;\n      continue;\n    }\n\n    switch (linkName) {\n      // poll is only found at the transaction\n      // level, so we don't need to pass the link\n      case 'poll':\n        fns.poll = getPollFn(sdk, res, ref);\n        break;\n\n      default:\n        var fn = link2fn(sdk, res, obj, link, ref);\n\n        if (fn) {\n          fns[linkName] = fn;\n        }\n\n    }\n  }\n\n  return fns;\n}\n\nfunction flattenEmbedded(sdk, res, obj, ref) {\n  obj = obj || res;\n  obj = util.clone(obj);\n\n  if (Array.isArray(obj)) {\n    var objArr = [];\n\n    for (var o = 0, ol = obj.length; o < ol; o++) {\n      objArr.push(flattenEmbedded(sdk, res, obj[o], ref));\n    }\n\n    return objArr;\n  }\n\n  var embedded = obj._embedded || {};\n\n  for (var key in embedded) {\n    if (!embedded.hasOwnProperty(key)) {\n      continue;\n    } // Flatten any nested _embedded objects\n\n\n    if (util.isObject(embedded[key]) || Array.isArray(embedded[key])) {\n      embedded[key] = flattenEmbedded(sdk, res, embedded[key], ref);\n    }\n  } // Convert any links on the embedded object\n\n\n  var fns = links2fns(sdk, res, obj, ref);\n  util.extend(embedded, fns);\n  obj = util.omit(obj, '_embedded', '_links');\n  util.extend(obj, embedded);\n  return obj;\n}\n\nfunction AuthTransaction(sdk, res) {\n  if (res) {\n    this.data = res;\n    util.extend(this, flattenEmbedded(sdk, res, res, {}));\n    delete this.stateToken; // RECOVERY_CHALLENGE has some responses without _links.\n    // Without _links, we emulate cancel to make it intuitive\n    // to return to the starting state. We may remove this\n    // when OKTA-75434 is resolved\n\n    if (res.status === 'RECOVERY_CHALLENGE' && !res._links) {\n      this.cancel = function () {\n        return new Q(new AuthTransaction(sdk));\n      };\n    }\n  }\n}\n\nmodule.exports = {\n  transactionStatus: transactionStatus,\n  resumeTransaction: resumeTransaction,\n  transactionExists: transactionExists,\n  postToTransaction: postToTransaction,\n  introspect: introspect\n};","map":{"version":3,"sources":["/app/node_modules/@okta/okta-auth-js/lib/tx.js"],"names":["http","require","util","Q","AuthSdkError","AuthPollStopError","config","addStateToken","res","options","builtArgs","extend","stateToken","getStateToken","transactionStatus","sdk","args","post","url","resumeTransaction","tx","exists","_get","STATE_TOKEN_KEY_NAME","reject","status","then","AuthTransaction","introspect","transactionStep","transactionExists","postToTransaction","getPollFn","ref","delay","rememberDevice","autoPush","transactionCallBack","isNumber","isObject","DEFAULT_POLLING_DELAY","pollLink","getLink","pollFn","opts","e","undefined","href","toQueryParams","saveAuthnState","isPolling","retryCount","recursivePoll","pollRes","factorResult","fail","err","xhr","delayLength","Math","pow","link2fn","obj","link","Array","isArray","name","lk","find","hints","allow","length","method","get","data","factorType","provider","params","omit","profile","updatePhone","links2fns","fns","linkName","_links","hasOwnProperty","type","poll","fn","flattenEmbedded","clone","objArr","o","ol","push","embedded","_embedded","key","cancel","module","exports"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\n\n/* eslint-disable complexity, max-statements */\nvar http              = require('./http');\nvar util              = require('./util');\nvar Q                 = require('q');\nvar AuthSdkError      = require('./errors/AuthSdkError');\nvar AuthPollStopError = require('./errors/AuthPollStopError');\nvar config            = require('./config');\n\nfunction addStateToken(res, options) {\n  var builtArgs = {};\n  util.extend(builtArgs, options);\n\n  // Add the stateToken if one isn't passed and we have one\n  if (!builtArgs.stateToken && res.stateToken) {\n    builtArgs.stateToken = res.stateToken;\n  }\n\n  return builtArgs;\n}\n\nfunction getStateToken(res) {\n  return addStateToken(res);\n}\n\nfunction transactionStatus(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/api/v1/authn', args);\n}\n\nfunction resumeTransaction(sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to resume'));\n    }\n  }\n  return sdk.tx.status(args)\n    .then(function(res) {\n      return new AuthTransaction(sdk, res);\n    });\n}\n\nfunction introspect (sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to evaluate'));\n    }\n  }\n  return transactionStep(sdk, args)\n    .then(function (res) {\n      return new AuthTransaction(sdk, res);\n    });\n}\n\nfunction transactionStep(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/idp/idx/introspect', args);\n}\n\nfunction transactionExists(sdk) {\n  // We have a cookie state token\n  return !!sdk.tx.exists._get(config.STATE_TOKEN_KEY_NAME);\n}\n\nfunction postToTransaction(sdk, url, args, options) {\n  return http.post(sdk, url, args, options)\n    .then(function(res) {\n      return new AuthTransaction(sdk, res);\n    });\n}\n\nfunction getPollFn(sdk, res, ref) {\n  return function (options) {\n    var delay;\n    var rememberDevice;\n    var autoPush;\n    var transactionCallBack;\n\n    if (util.isNumber(options)) {\n      delay = options;\n    } else if (util.isObject(options)) {\n      delay = options.delay;\n      rememberDevice = options.rememberDevice;\n      autoPush = options.autoPush;\n      transactionCallBack = options.transactionCallBack;\n    }\n\n    if (!delay && delay !== 0) {\n      delay = config.DEFAULT_POLLING_DELAY;\n    }\n\n    // Get the poll function\n    var pollLink = util.getLink(res, 'next', 'poll');\n    function pollFn() {\n      var opts = {};\n      if (typeof autoPush === 'function') {\n        try {\n          opts.autoPush = !!autoPush();\n        }\n        catch (e) {\n          return Q.reject(new AuthSdkError('AutoPush resulted in an error.'));\n        }\n      }\n      else if (autoPush !== undefined && autoPush !== null) {\n        opts.autoPush = !!autoPush;\n      }\n      if (typeof rememberDevice === 'function') {\n        try {\n          opts.rememberDevice = !!rememberDevice();\n        }\n        catch (e) {\n          return Q.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n        }\n      }\n      else if (rememberDevice !== undefined && rememberDevice !== null) {\n        opts.rememberDevice = !!rememberDevice;\n      }\n\n      var href = pollLink.href + util.toQueryParams(opts);\n      return http.post(sdk, href, getStateToken(res), {\n        saveAuthnState: false  \n      });\n    }\n\n    ref.isPolling = true;\n\n    var retryCount = 0;\n    var recursivePoll = function () {\n      // If the poll was manually stopped during the delay\n      if (!ref.isPolling) {\n        return Q.reject(new AuthPollStopError());\n      }\n      return pollFn()\n        .then(function (pollRes) {\n          // Reset our retry counter on success\n          retryCount = 0;\n\n          // If we're still waiting\n          if (pollRes.factorResult && pollRes.factorResult === 'WAITING') {\n\n            // If the poll was manually stopped while the pollFn was called\n            if (!ref.isPolling) {\n              throw new AuthPollStopError();\n            }\n\n            if (typeof transactionCallBack === 'function') {\n              transactionCallBack(pollRes);\n            }\n\n            // Continue poll\n            return Q.delay(delay)\n              .then(recursivePoll);\n\n          } else {\n            // Any non-waiting result, even if polling was stopped\n            // during a request, will return\n            ref.isPolling = false;\n            return new AuthTransaction(sdk, pollRes);\n          }\n        })\n        .fail(function(err) {\n          // Exponential backoff, up to 16 seconds\n          if (err.xhr &&\n              (err.xhr.status === 0 || err.xhr.status === 429) &&\n              retryCount <= 4) {\n            var delayLength = Math.pow(2, retryCount) * 1000;\n            retryCount++;\n            return Q.delay(delayLength)\n              .then(recursivePoll);\n          }\n          throw err;\n        });\n    };\n    return recursivePoll()\n      .fail(function(err) {\n        ref.isPolling = false;\n        throw err;\n      });\n  };\n}\n\nfunction link2fn(sdk, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function(name, opts) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = util.find(link, {name: name});\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, res, obj, lk, ref)(opts);\n    };\n\n  } else if (link.hints &&\n      link.hints.allow &&\n      link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n    switch (method) {\n\n      case 'GET':\n        return function() {\n          return http.get(sdk, link.href);\n        };\n\n      case 'POST':\n        return function(opts) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL' || res.status === 'FACTOR_ENROLL') {\n            // Add factorType and provider\n            util.extend(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var params = {};\n          var autoPush = data.autoPush;\n          if (autoPush !== undefined) {\n            if (typeof autoPush === 'function') {\n              try {\n                params.autoPush = !!autoPush();\n              }\n              catch (e) {\n                return Q.reject(new AuthSdkError('AutoPush resulted in an error.'));\n              }\n            }\n            else if (autoPush !== null) {\n              params.autoPush = !!autoPush;\n            }\n            data = util.omit(data, 'autoPush');\n          }\n\n          var rememberDevice = data.rememberDevice;\n          if (rememberDevice !== undefined) {\n            if (typeof rememberDevice === 'function') {\n              try {\n                params.rememberDevice = !!rememberDevice();\n              }\n              catch (e) {\n                return Q.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n              }\n            }\n            else if (rememberDevice !== null) {\n              params.rememberDevice = !!rememberDevice;\n            }\n            data = util.omit(data, 'rememberDevice');\n\n          } else if (data.profile &&\n                    data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              params.updatePhone = true;\n            }\n            data.profile = util.omit(data.profile, 'updatePhone');\n          }\n          var href = link.href + util.toQueryParams(params);\n          return postToTransaction(sdk, href, data);\n        };\n    }\n  }\n}\n\nfunction links2fns(sdk, res, obj, ref) {\n  var fns = {};\n  for (var linkName in obj._links) {\n    if (!obj._links.hasOwnProperty(linkName)) {\n      continue;\n    }\n\n    var link = obj._links[linkName];\n    \n    if (linkName === 'next') {\n      linkName = link.name;\n    }\n\n    if (link.type) {\n      fns[linkName] = link;\n      continue;\n    }\n\n    switch (linkName) {\n      // poll is only found at the transaction\n      // level, so we don't need to pass the link\n      case 'poll':\n        fns.poll = getPollFn(sdk, res, ref);\n        break;\n\n      default:\n        var fn = link2fn(sdk, res, obj, link, ref);\n        if (fn) {\n          fns[linkName] = fn;\n        }\n    }\n  }\n  return fns;\n}\n\nfunction flattenEmbedded(sdk, res, obj, ref) {\n  obj = obj || res;\n  obj = util.clone(obj);\n\n  if (Array.isArray(obj)) {\n    var objArr = [];\n    for (var o = 0, ol = obj.length; o < ol; o++) {\n      objArr.push(flattenEmbedded(sdk, res, obj[o], ref));\n    }\n    return objArr;\n  }\n\n  var embedded = obj._embedded || {};\n\n  for (var key in embedded) {\n    if (!embedded.hasOwnProperty(key)) {\n      continue;\n    }\n\n    // Flatten any nested _embedded objects\n    if (util.isObject(embedded[key]) || Array.isArray(embedded[key])) {\n      embedded[key] = flattenEmbedded(sdk, res, embedded[key], ref);\n    }\n  }\n\n  // Convert any links on the embedded object\n  var fns = links2fns(sdk, res, obj, ref);\n  util.extend(embedded, fns);\n\n  obj = util.omit(obj, '_embedded', '_links');\n  util.extend(obj, embedded);\n  return obj;\n}\n\nfunction AuthTransaction(sdk, res) {\n  if (res) {\n    this.data = res;\n    util.extend(this, flattenEmbedded(sdk, res, res, {}));\n    delete this.stateToken;\n\n    // RECOVERY_CHALLENGE has some responses without _links.\n    // Without _links, we emulate cancel to make it intuitive\n    // to return to the starting state. We may remove this\n    // when OKTA-75434 is resolved\n    if (res.status === 'RECOVERY_CHALLENGE' && !res._links) {\n      this.cancel = function() {\n        return new Q(new AuthTransaction(sdk));\n      };\n    }\n  }\n}\n\nmodule.exports = {\n  transactionStatus: transactionStatus,\n  resumeTransaction: resumeTransaction,\n  transactionExists: transactionExists,\n  postToTransaction: postToTransaction,\n  introspect: introspect,\n};\n"]},"metadata":{},"sourceType":"script"}